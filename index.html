<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Informatics Portal</title>

  <style>
    :root{
      --bg0:#07110F; --bg1:#0A1714;
      --cream:#F2EAD5; --teal:#4C9485; --deep:#306156;
      --card: rgba(242,234,213,0.07);
      --card2: rgba(242,234,213,0.045);
      --stroke: rgba(242,234,213,0.14);
      --text: rgba(242,234,213,0.94);
      --muted: rgba(242,234,213,0.70);
      --good:#32D583; --bad:#FF5A5F; --warn:#F7B955;
      --shadow: 0 22px 60px rgba(0,0,0,0.55);
      --radius: 18px;
      --ease: cubic-bezier(.2,.9,.2,1);
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(900px 540px at 18% -5%, rgba(76,148,133,0.25), transparent 60%),
        radial-gradient(900px 540px at 92% 0%, rgba(48,97,86,0.25), transparent 58%),
        radial-gradient(900px 700px at 50% 115%, rgba(242,234,213,0.08), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
	background-attachment: fixed;
  	background-repeat: no-repeat;
    }
    .bg-shimmer{
      position:fixed; inset:-40%;
      background: linear-gradient(120deg,
        transparent 0%,
        rgba(242,234,213,0.06) 15%,
        transparent 30%,
        transparent 60%,
        rgba(76,148,133,0.08) 75%,
        transparent 90%);
      transform: translateX(-20%);
      animation: shimmer 11s linear infinite alternate;
      pointer-events:none;
      filter: blur(16px);
      opacity:.65;
    }
    @keyframes shimmer{ 0%{transform:translateX(-25%) rotate(5deg);} 100%{transform:translateX(25%) rotate(5deg);} }

    /* Far top-left logo (no bubble) */
    .mngha-fixed{
      position: fixed; top: 18px; left: 18px; z-index: 9999;
      width: 190px; height: 74px;
      background: transparent; border:none; box-shadow:none; padding:0; margin:0;
      display:flex; align-items:center; justify-content:flex-start;
      transition: transform 200ms var(--ease), filter 200ms var(--ease), opacity 200ms var(--ease);
    }
    .mngha-fixed:hover{ transform: translateY(-1px); filter: brightness(1.06); opacity:.98; }
    .mngha-fixed img{ width:100%; height:100%; object-fit:contain; display:block; }

    .wrap{
      width:min(980px, calc(100% - 32px));
      margin: 46px auto 60px;
      position:relative;
      animation: enter 700ms var(--ease) both;
    }
    @keyframes enter{ from{opacity:0; transform:translateY(16px) scale(.985);} to{opacity:1; transform:translateY(0) scale(1);} }

    header{
      display:flex; align-items:center; gap:16px;
      margin-bottom:14px;
    }
    .logoWrap{
      width:208px; height:208px; border-radius:22px;
      background: rgba(242,234,213,0.10);
      border: 1px solid rgba(242,234,213,0.18);
      box-shadow: 0 16px 34px rgba(0,0,0,0.45);
      display:grid; place-items:center;
      overflow:hidden; position:relative;
    }
    .logoWrap::before{
      content:""; position:absolute; inset:-2px;
      background:
        radial-gradient(32px 32px at 25% 20%, rgba(242,234,213,0.30), transparent 55%),
        radial-gradient(42px 42px at 80% 10%, rgba(76,148,133,0.22), transparent 60%);
      filter: blur(10px); opacity:0.9; pointer-events:none;
    }
    .logoImg{ width:192px; height:192px; object-fit:contain; display:block; position:relative; z-index:1; }
    .brand{ display:flex; flex-direction:column; line-height:1.1; }
    .brand .title{ font-size:1.38rem; letter-spacing:-0.02em; font-weight:900; }
    .brand .subtitle{ color:var(--muted); font-size:0.98rem; margin-top:6px; }

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding:20px;
      position:relative; overflow:hidden;
    }
    .card::before{
      content:""; position:absolute; inset:-2px;
      background:
        radial-gradient(700px 260px at 20% 0%, rgba(76,148,133,0.20), transparent 55%),
        radial-gradient(700px 260px at 80% 0%, rgba(48,97,86,0.22), transparent 55%);
      opacity:0.95; pointer-events:none; filter: blur(16px);
    }
    .card > *{ position:relative; z-index:1; }

    .grid{ display:grid; gap:14px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .cols{ display:grid; gap:14px; grid-template-columns: 1.1fr 0.9fr; }
    @media (max-width: 900px){ .cols{ grid-template-columns: 1fr; } }

    label{ display:block; font-size:0.92rem; color:var(--muted); margin-bottom:8px; user-select:none; }
    input, select, textarea{
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(242,234,213,0.18);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      outline:none;
      transition: border-color 200ms var(--ease), box-shadow 200ms var(--ease), transform 200ms var(--ease);
      font-size:1rem;
    }
    textarea{ min-height: 110px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(76,148,133,0.70);
      box-shadow: 0 0 0 4px rgba(76,148,133,0.16);
      transform: translateY(-1px);
    }

    button{
      border:0; border-radius: 14px;
      padding: 12px 14px;
      font-weight:900;
      cursor:pointer;
      transition: transform 200ms var(--ease), filter 200ms var(--ease), box-shadow 200ms var(--ease), opacity 200ms var(--ease);
      display:inline-flex; align-items:center; gap:10px;
      user-select:none; white-space:nowrap;
    }
    button:active{ transform: translateY(1px) scale(0.99); }
    button:disabled{ cursor:not-allowed; opacity:.55; }
    .btn-primary{
      background: linear-gradient(135deg, var(--teal), var(--deep));
      color: rgba(7,17,15,0.96);
      box-shadow: 0 16px 34px rgba(76,148,133,0.18);
    }
    .btn-primary:hover{ filter: brightness(1.06); transform: translateY(-1px); }
    .btn-ghost{
      background: rgba(242,234,213,0.08);
      border: 1px solid rgba(242,234,213,0.18);
      color: var(--text);
    }
    .btn-ghost:hover{ background: rgba(242,234,213,0.11); transform: translateY(-1px); }

    .status{
      display:flex; align-items:center; gap:10px;
      color: var(--muted);
      min-height: 22px;
      font-size:0.98rem;
      margin-top: 10px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(242,234,213,0.18);
      background: rgba(0,0,0,0.18);
      color: rgba(242,234,213,0.88);
      font-weight:900; font-size:0.86rem;
      letter-spacing: 0.01em;
    }
    .pill.good{ border-color: rgba(50,213,131,0.38); color: rgba(50,213,131,0.98); }
    .pill.bad{ border-color: rgba(255,90,95,0.38); color: rgba(255,90,95,0.98); }
    .pill.warn{ border-color: rgba(247,185,85,0.38); color: rgba(247,185,85,0.98); }
    .pill.pending{ border-color: rgba(247,185,85,0.35); color: rgba(247,185,85,0.95); }
    .pill.approved{ border-color: rgba(50,213,131,0.35); color: rgba(50,213,131,0.95); }
    .pill.rejected{ border-color: rgba(255,90,95,0.35); color: rgba(255,90,95,0.95); }

    .box{
      border-radius: 16px;
      border: 1px solid rgba(242,234,213,0.14);
      background: rgba(0,0,0,0.18);
      padding: 14px;
    }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(242,234,213,0.16);
      background: rgba(0,0,0,0.16);
      font-weight:850;
      font-size:0.9rem;
      color: rgba(242,234,213,0.9);
    }
    .chip button{
      padding:0; border-radius:10px;
      background: transparent; border:none;
      color: rgba(242,234,213,0.8);
      cursor:pointer;
      font-weight:900;
    }

    table{ width:100%; border-collapse: collapse; }
    th, td{
      text-align:left;
      padding: 10px 8px;
      border-bottom: 1px solid rgba(242,234,213,0.10);
      vertical-align: top;
      font-size: 0.95rem;
    }
    th{ color: rgba(242,234,213,0.75); font-size:0.9rem; }
    .muted{ color: rgba(242,234,213,0.72); }
    .hidden{ display:none !important; }

    .spinner{
      width:16px; height:16px; border-radius:50%;
      border: 2px solid rgba(7,17,15,0.25);
      border-top-color: rgba(7,17,15,0.92);
      animation: spin 700ms linear infinite;
      display:none;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .toast{
      position:fixed; left:50%; bottom:18px; transform: translateX(-50%);
      background: rgba(0,0,0,0.60);
      border: 1px solid rgba(242,234,213,0.14);
      padding: 10px 12px;
      border-radius: 14px;
      color: rgba(242,234,213,0.92);
      box-shadow: 0 16px 40px rgba(0,0,0,0.55);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      opacity:0; pointer-events:none;
    }
    .toast.show{ animation: toastInOut 2200ms var(--ease) both; }
    @keyframes toastInOut{
      0%{ opacity:0; transform: translateX(-50%) translateY(10px); }
      12%{ opacity:1; transform: translateX(-50%) translateY(0); }
      85%{ opacity:1; transform: translateX(-50%) translateY(0); }
      100%{ opacity:0; transform: translateX(-50%) translateY(10px); }
    }
  </style>
</head>

<body>
  <a class="mngha-fixed" href="#" aria-label="MNGHA">
    <img src="MNGHAlogo.svg" alt="MNGHA Logo" onerror="this.onerror=null; this.src='MNGHAlogo.png';" />
  </a>

  <div class="bg-shimmer"></div>

  <div class="wrap">
    <header>
      <div class="logoWrap">
        <img class="logoImg" src="InformaticsLogo.svg" alt="App Logo" onerror="this.onerror=null; this.src='InformaticsLogo.png';" />
      </div>
      <div class="brand">
        <div class="title">Informatics Portal</div>
        <div class="subtitle">OTP Login ‚Ä¢ Submit requests ‚Ä¢ Track approvals</div>
      </div>
    </header>

    <div class="card">
      <!-- LOGIN VIEW -->
      <div id="viewLogin" class="grid">
        <div class="box">
          <div class="grid">
            <div>
              <label for="email">Username</label>
              <input id="email" type="email" placeholder="USERNAME01" autocomplete="email" />
              <div class="muted" style="margin-top:8px;">We will send a 6-digit OTP to your email.</div>
            </div>
            <div class="row">
              <button class="btn-primary" id="btnSend" type="button">
                ‚úâÔ∏è Send OTP <span class="spinner" id="spinSend"></span>
              </button>
            </div>
          </div>
        </div>

        <div id="otpBox" class="box hidden">
          <div class="grid">
            <div>
              <label for="otp">Enter OTP (6 digits)</label>
              <input id="otp" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="123456" autocomplete="one-time-code" />
              <div class="muted" style="margin-top:8px;">OTP expires in 10 minutes.</div>
            </div>
            <div class="row">
              <button class="btn-primary" id="btnVerify" type="button">
                ‚úÖ Verify <span class="spinner" id="spinVerify"></span>
              </button>
              <button class="btn-ghost" id="btnResend" type="button">üîÅ Resend</button>
            </div>
          </div>
        </div>
      </div>

      <!-- APP VIEW -->
      <div id="viewApp" class="grid hidden">
        <div class="row" style="justify-content: space-between;">
          <div class="status" style="margin:0;">
            <span class="pill good">Logged in</span>
            <span id="meText"></span>
          </div>
          <div class="row">
            <button class="btn-ghost" id="btnRefresh" type="button">üîÑ Refresh</button>
            <button class="btn-ghost" id="btnLogout" type="button">üö™ Logout</button>
          </div>
        </div>

        <div class="cols">
          <!-- LEFT: Balance + Submit -->
          <div class="grid">
            <div class="box">
              <div class="row" style="justify-content: space-between;">
                <div>
                  <div class="muted">Remaining Lieu Days</div>
                  <div style="font-size:2.0rem; font-weight:950; margin-top:4px;" id="lieuDaysText">‚Äî</div>
                </div>
                <div class="pill" id="balancePill">Balance</div>
              </div>
              <div class="muted" style="margin-top:10px;" id="approversText"></div>
            </div>

            <div class="box">
              <div style="font-weight:950; font-size:1.05rem; margin-bottom:10px;">Submit Overtime Reimbursement</div>

              <div class="grid">
                <div>
                  <label>Add Covered Day</label>
                  <div class="row">
                    <input id="datePick" type="date" />
                    <button class="btn-ghost" id="btnAddDate" type="button">‚ûï Add</button>
                    <button class="btn-ghost" id="btnClearDates" type="button">üßπ Clear</button>
                  </div>
                  <div class="muted" style="margin-top:8px;">Selected days: <b id="daysCountText">0</b></div>
                  <div class="chips" id="chips"></div>
                </div>

                <div>
                  <label for="reqType">Reimbursement Type</label>
                  <select id="reqType">
                    <option value="Paid Overtime">Paid Overtime</option>
                    <option value="Lieu Days">Lieu Days</option>
                  </select>
                  <div class="muted" style="margin-top:8px;">If approved as <b>Lieu Days</b>, the days will be added to your balance.</div>
                </div>

                <div>
                  <label for="justification">Justification</label>
                  <textarea id="justification" placeholder="Write the reason, shift details, coverage context, etc."></textarea>
                </div>

                <div class="row">
                  <button class="btn-primary" id="btnSubmit" type="button">
                    üì© Submit Request <span class="spinner" id="spinSubmit"></span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT: Requests table -->
          <div class="box">
            <div class="row" style="justify-content: space-between; margin-bottom:10px;">
              <div style="font-weight:950; font-size:1.05rem;">My Requests</div>
              <div class="muted" id="reqCountText"></div>
            </div>

            <div style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Days</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody id="reqTbody">
                  <tr><td colspan="5" class="muted">No data yet.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Shared status line -->
      <div class="status" id="status">
        <span class="pill" id="statusPill" style="display:none;"></span>
        <span id="statusText"></span>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ====== POWER AUTOMATE FLOWS ======
    const FLOW_SEND_OTP     = "https://defaultb84725a503734d779259051685769b.f2.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/6349151fa8de4a45875e0b05ef63b135/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=XBNbnL9iYoKHYmAjc-MZ9ImWvb5dELBsnT3arFmNEOc";
    const FLOW_VERIFY_OTP   = "https://defaultb84725a503734d779259051685769b.f2.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/814ea5e30d7d4f6cbdc0a1068b0003f1/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=unYlz1quTODrvyizYKjVvWYgZ5bC7c4HzS1W1yrLEeQ";
    const FLOW_DASHBOARD    = "https://defaultb84725a503734d779259051685769b.f2.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/913a3b9a2903473da79423c9ee3d75d4/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2yjch6FFOI1SHv6EjWG1HsLtiWBlQ2Nqjgyy6OcYFdw";    // returns balance + requests
    const FLOW_SUBMIT_REQUEST = "https://defaultb84725a503734d779259051685769b.f2.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4d39cc17dad141a08cc256ca553afb03/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=i43xMbkdxRvYDcOEEfXPgjvGPaKfvMxBG49PEpkQXGs";

    // Session storage
    const SESSION_KEY = "otp_portal_session_v1";

    // ====== UI ======
    const el = (id) => document.getElementById(id);
    const toast = el("toast");

    const viewLogin = el("viewLogin");
    const viewApp   = el("viewApp");
    const otpBox    = el("otpBox");

    const emailInput = el("email");
    const otpInput   = el("otp");

    const btnSend = el("btnSend");
    const btnVerify = el("btnVerify");
    const btnResend = el("btnResend");

    const spinSend = el("spinSend");
    const spinVerify = el("spinVerify");
    const spinSubmit = el("spinSubmit");

    const btnLogout = el("btnLogout");
    const btnRefresh = el("btnRefresh");

    const meText = el("meText");
    const lieuDaysText = el("lieuDaysText");
    const approversText = el("approversText");

    const datePick = el("datePick");
    const btnAddDate = el("btnAddDate");
    const btnClearDates = el("btnClearDates");
    const chips = el("chips");
    const daysCountText = el("daysCountText");

    const reqType = el("reqType");
    const justification = el("justification");
    const btnSubmit = el("btnSubmit");

    const reqTbody = el("reqTbody");
    const reqCountText = el("reqCountText");

    const statusText = el("statusText");
    const statusPill = el("statusPill");

    let selectedDates = [];

    function showToast(message){
      toast.textContent = message;
      toast.classList.remove("show");
      void toast.offsetWidth;
      toast.classList.add("show");
    }

    function setStatus(type, message){
      statusText.textContent = message || "";
      if (!message){
        statusPill.style.display = "none";
        return;
      }
      statusPill.style.display = "inline-flex";
      statusPill.className = "pill " + (type || "");
      statusPill.textContent = type === "good" ? "Success" :
                               type === "bad"  ? "Error" :
                               type === "warn" ? "Working" : "Info";
    }

    function setLoading(which, on){
      const map = { send: spinSend, verify: spinVerify, submit: spinSubmit };
      const sp = map[which];
      if (sp) sp.style.display = on ? "inline-block" : "none";

      btnSend.disabled = on;
      btnVerify.disabled = on;
      btnResend.disabled = on;
      btnSubmit.disabled = on;
      btnRefresh && (btnRefresh.disabled = on);
      btnLogout && (btnLogout.disabled = on);
    }

    function saveSession(s){ sessionStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
    function loadSession(){ try{ return JSON.parse(sessionStorage.getItem(SESSION_KEY) || "null"); }catch{ return null; } }
    function clearSession(){ sessionStorage.removeItem(SESSION_KEY); }

    async function postJSON(url, payload){
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      let data;
      try{ data = JSON.parse(text); } catch { data = { success:false, raw:text, httpStatus: res.status }; }
      return { status: res.status, data };
    }

    function showLogin(){
      viewApp.classList.add("hidden");
      viewLogin.classList.remove("hidden");
      otpBox.classList.add("hidden");
      setStatus("", "");
      emailInput.focus();
    }

    function showApp(){
      viewLogin.classList.add("hidden");
      viewApp.classList.remove("hidden");
      setStatus("", "");
    }

    // ===== Dates UI =====
    function renderDates(){
      chips.innerHTML = "";
      selectedDates.sort();
      for (const d of selectedDates){
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.innerHTML = `<span>${d}</span>`;
        const x = document.createElement("button");
        x.type = "button";
        x.textContent = "‚úï";
        x.onclick = () => { selectedDates = selectedDates.filter(v => v !== d); renderDates(); };
        chip.appendChild(x);
        chips.appendChild(chip);
      }
      daysCountText.textContent = String(selectedDates.length);
    }

    btnAddDate.addEventListener("click", () => {
      const d = datePick.value;
      if (!d) return;
      if (!selectedDates.includes(d)) selectedDates.push(d);
      renderDates();
    });

    btnClearDates.addEventListener("click", () => {
      selectedDates = [];
      renderDates();
    });

    // ===== Requests table =====
    function statusPillFor(s){
      const t = String(s || "").toLowerCase();
      if (t.includes("approve")) return `<span class="pill approved">Approved</span>`;
      if (t.includes("reject")) return `<span class="pill rejected">Rejected</span>`;
      return `<span class="pill pending">Pending</span>`;
    }

    function renderRequests(reqs){
      reqCountText.textContent = `${reqs.length} request(s)`;
      if (!reqs.length){
        reqTbody.innerHTML = `<tr><td colspan="5" class="muted">No requests yet.</td></tr>`;
        return;
      }

      // newest first if Created exists
      reqs.sort((a,b) => (b.created || "").localeCompare(a.created || ""));

      reqTbody.innerHTML = "";
      for (const r of reqs){
        const created = r.created ? new Date(r.created).toLocaleString() : (r.created || "‚Äî");
        const days = r.daysCount ?? "‚Äî";
        const type = r.requestType ?? "‚Äî";
        const status = statusPillFor(r.status);
        const details = (r.approvalSummary || "").toString().slice(0, 120) + ((r.approvalSummary||"").length>120 ? "‚Ä¶" : "");
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${created}</td>
          <td>${days}</td>
          <td>${type}</td>
          <td>${status}</td>
          <td class="muted">${details || "‚Äî"}</td>
        `;
        reqTbody.appendChild(row);
      }
    }

    // ===== Actions =====
    btnSend.addEventListener("click", async () => {
      const email = emailInput.value.trim();
     // if (!email || !email.includes("@")) { setStatus("bad", "Enter a valid work email."); return; }

      setLoading("send", true);
      setStatus("warn", "Sending OTP‚Ä¶");

      const { data } = await postJSON(FLOW_SEND_OTP, { email });

      setLoading("send", false);

      if (!data.success){
        setStatus("bad", data.message || "Could not send OTP.");
        showToast("OTP failed");
        return;
      }

      setStatus("good", "OTP sent. Check your inbox.");
      otpBox.classList.remove("hidden");
      otpInput.value = "";
      otpInput.focus();
      showToast("OTP sent");
    });

    btnResend.addEventListener("click", () => btnSend.click());

    btnVerify.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const otp = otpInput.value.trim().replace(/\s+/g,"");
      if (!/^\d{6}$/.test(otp)){ setStatus("bad", "OTP must be 6 digits."); return; }

      setLoading("verify", true);
      setStatus("warn", "Verifying‚Ä¶");

      const { data } = await postJSON(FLOW_VERIFY_OTP, { email, otp });

      setLoading("verify", false);

      if (!data.success){
        setStatus("bad", data.message || "Invalid / expired OTP.");
        showToast("Invalid OTP");
        return;
      }

      // Save token
      saveSession({ token: data.token, expiresAt: data.expiresAt });
      showToast("Welcome");
      await loadDashboard();
    });

    async function loadDashboard(){
      const s = loadSession();
      if (!s?.token){ showLogin(); return; }

      setStatus("warn", "Loading dashboard‚Ä¶");
      const { data } = await postJSON(FLOW_DASHBOARD, { token: s.token });

      if (!data.success){
        clearSession();
        setStatus("bad", data.message || "Session expired. Please login again.");
        showLogin();
        return;
      }

      showApp();
      meText.textContent = `${data.displayName || data.email}`;
      lieuDaysText.textContent = String(data.lieuDays ?? 0);
      approversText.textContent = `Approvers: Supervisor (${data.supervisorEmail || "‚Äî"}) ‚Ä¢ Assistant Director (${data.assistantDirectorEmail || "‚Äî"})`;

      renderRequests(data.requests || []);
      setStatus("good", "Ready.");
    }

    btnRefresh.addEventListener("click", loadDashboard);

    btnSubmit.addEventListener("click", async () => {
      const s = loadSession();
      if (!s?.token){ showLogin(); return; }

      if (!selectedDates.length){
        setStatus("bad", "Please add at least one covered day.");
        return;
      }
      const just = justification.value.trim();
      if (just.length < 10){
        setStatus("bad", "Please write a brief justification (at least 10 characters).");
        return;
      }

      setLoading("submit", true);
      setStatus("warn", "Submitting request‚Ä¶");

      const payload = {
        token: s.token,
        dates: selectedDates,
        requestType: reqType.value,
        justification: just
      };

      const { data } = await postJSON(FLOW_SUBMIT_REQUEST, payload);

      setLoading("submit", false);

      if (!data.success){
        setStatus("bad", data.message || "Submit failed.");
        showToast("Submit failed");
        return;
      }

      setStatus("good", "Request submitted for approval.");
      showToast("Submitted");
      // reset form
      selectedDates = [];
      renderDates();
      justification.value = "";
      // refresh list
      await loadDashboard();
    });

    btnLogout.addEventListener("click", () => {
      clearSession();
      showToast("Logged out");
      showLogin();
    });

    // init
    renderDates();
    loadDashboard();
  </script>
</body>
</html>
